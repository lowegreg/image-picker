(function(){var e,t,i,s,l=function(e,t){return function(){return e.apply(t,arguments)}},n=[].indexOf||function(e){for(var t=0,i=this.length;t<i;t++)if(t in this&&this[t]===e)return t;return-1};jQuery.fn.extend({imagepicker:function(t){return null==t&&(t={}),this.each(function(){var i;if(i=jQuery(this),i.data("picker")&&i.data("picker").destroy(),i.data("picker",new e(this,s(t))),null!=t.initialized)return t.initialized.call(i.data("picker"))})}}),s=function(e){var t;return t={hide_select:!0,show_label:!1,initialized:void 0,changed:void 0,clicked:void 0,selected:void 0,limit:void 0,limit_reached:void 0,font_awesome:!1},jQuery.extend(t,e)},i=function(e,t){var i,s,l,n;if(!e||!t||e.length!==t.length)return!1;for(e=e.slice(0),t=t.slice(0),e.sort(),t.sort(),i=s=0,l=e.length;s<l;i=++s)if(n=e[i],t[i]!==n)return!1;return!0},e=function(){function e(e,t){this.opts=null!=t?t:{},this.sync_picker_with_select=l(this.sync_picker_with_select,this),this.select=jQuery(e),this.multiple="multiple"===this.select.attr("multiple"),null!=this.select.data("limit")&&(this.opts.limit=parseInt(this.select.data("limit"))),this.build_and_append_picker()}return e.prototype.destroy=function(){var e,t,i,s;for(s=this.picker_options,e=0,t=s.length;e<t;e++)i=s[e],i.destroy();return this.picker.remove(),this.select.off("change",this.sync_picker_with_select),this.select.removeData("picker"),this.select.show()},e.prototype.build_and_append_picker=function(){return this.opts.hide_select&&this.select.hide(),this.select.on("change",this.sync_picker_with_select),null!=this.picker&&this.picker.remove(),this.create_picker(),this.select.after(this.picker),this.sync_picker_with_select()},e.prototype.sync_picker_with_select=function(){var e,t,i,s,l;for(s=this.picker_options,l=[],e=0,t=s.length;e<t;e++)i=s[e],i.is_selected()?l.push(i.mark_as_selected()):l.push(i.unmark_as_selected());return $("li",this.picker).find(".thumbnail").each(function(){$(this).hasClass("selected")?$(this).find(".image_picker_image").prop("tabindex","0"):$(this).find(".image_picker_image").prop("tabindex","-1")}),0===$("li",this.picker).find(".selected").length&&$("li:first-child",this.picker).find(".image_picker_image").prop("tabindex","0"),l},e.prototype.create_picker=function(){return this.picker=jQuery("<ul class='thumbnails image_picker_selector'></ul>"),this.picker_options=[],this.recursively_parse_option_groups(this.select,this.picker),this.picker},e.prototype.recursively_parse_option_groups=function(e,i){var s,l,n,r,c,a,h,o,p,u;for(o=e.children("optgroup"),l=0,r=o.length;l<r;l++)h=o[l],h=jQuery(h),s=jQuery("<ul></ul>"),s.append(jQuery("<li class='group_title'>"+h.attr("label")+"</li>")),i.append(jQuery("<li class='group'>").append(s)),this.recursively_parse_option_groups(h,s);for(p=function(){var i,s,l,n;for(l=e.children("option"),n=[],i=0,s=l.length;i<s;i++)a=l[i],n.push(new t(a,this,this.opts));return n}.call(this),u=[],n=0,c=p.length;n<c;n++)a=p[n],this.picker_options.push(a),a.has_image()&&u.push(i.append(a.node));return u},e.prototype.has_implicit_blanks=function(){var e;return function(){var t,i,s,l;for(s=this.picker_options,l=[],t=0,i=s.length;t<i;t++)e=s[t],e.is_blank()&&!e.has_image()&&l.push(e);return l}.call(this).length>0},e.prototype.selected_values=function(){return this.multiple?this.select.val()||[]:[this.select.val()]},e.prototype.toggle=function(e,t){var s,l,r;if(l=this.selected_values(),r=e.value().toString(),this.multiple?n.call(this.selected_values(),r)>=0?(s=this.selected_values(),s.splice(jQuery.inArray(r,l),1),this.select.val([]),this.select.val(s)):null!=this.opts.limit&&this.selected_values().length>=this.opts.limit?null!=this.opts.limit_reached&&this.opts.limit_reached.call(this.select):this.select.val(this.selected_values().concat(r)):this.has_implicit_blanks()&&e.is_selected()?this.select.val(""):this.select.val(r),!i(l,this.selected_values())&&(this.select.change(),null!=this.opts.changed))return this.opts.changed.call(this.select,l,this.selected_values(),t)},e}(),t=function(){function e(e,t,i){this.picker=t,this.opts=null!=i?i:{},this.clicked=l(this.clicked,this),this.option=jQuery(e),this.create_node()}return e.prototype.destroy=function(){return this.node.find(".thumbnail").off("click",this.clicked)},e.prototype.has_image=function(){return null!=this.option.data("img-src")},e.prototype.is_blank=function(){return!(null!=this.value()&&""!==this.value())},e.prototype.is_selected=function(){var e;return e=this.picker.select.val(),this.picker.multiple?jQuery.inArray(this.value(),e)>=0:this.value()===e},e.prototype.mark_as_selected=function(){return this.node.find(".thumbnail").addClass("selected")},e.prototype.unmark_as_selected=function(){return this.node.find(".thumbnail").removeClass("selected")},e.prototype.value=function(){return this.option.val()},e.prototype.label=function(){return this.option.data("img-label")?this.option.data("img-label"):this.option.text()},e.prototype.clicked=function(e){if(this.picker.toggle(this,e),null!=this.opts.clicked&&this.opts.clicked.call(this.picker.select,this,e),null!=this.opts.selected&&this.is_selected())return this.opts.selected.call(this.picker.select,this,e)},e.prototype.create_node=function(){var e,t,i,s;return this.node=jQuery("<li/>"),this.option.data("font_awesome")?(e=jQuery("<i>"),e.attr("class","fa-fw "+this.option.data("img-src"))):(e=jQuery("<img class='image_picker_image'/>"),e.attr("src",this.option.data("img-src"))),s=jQuery("<div class='thumbnail'>"),i=this.option.data("img-class"),i&&(this.node.addClass(i),e.addClass(i),s.addClass(i)),t=this.option.data("img-alt"),t&&e.attr("alt",t),s.on("click",this.clicked),s.on("keydown",function(e){0===e.which||32===e.which||13===e.which?(e.preventDefault(),s.click()):37===e.which||40===e.which?(e.preventDefault(),$(this).parent().prev().find(".image_picker_image").prop("tabindex","0"),$(this).parent().prev().find(".image_picker_image").focus()):38!==e.which&&39!==e.which||(e.preventDefault(),$(this).parent().next().find(".image_picker_image").prop("tabindex","0"),$(this).parent().next().find(".image_picker_image").focus())}),s.on("focusout",function(e){$(this).closest("ul").find(".thumbnail").each(function(){$(this).hasClass("selected")&&!$(e.relatedTarget).hasClass("image_picker_image")?$(this).find(".image_picker_image").prop("tabindex","0"):$(this).find(".image_picker_image").prop("tabindex","-1")}),0!==$(this).closest("ul").find(".selected").length||$(e.relatedTarget).hasClass("image_picker_image")||$("li:first-child",$(this).closest("ul")).find(".image_picker_image").prop("tabindex","0")}),s.append(e),this.opts.show_label&&s.append(jQuery("<p/>").html(this.label())),this.node.append(s),this.node},e}()}).call(this);